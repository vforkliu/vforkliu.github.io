<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">










<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-9880926895077532",
          enable_page_level_ads: true
     });
</script>














<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-e.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-e.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-e.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo-e.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="基于AOSP 8.0.1源码分析force-stop的实现细节。 使用 force-stop1am force-stop com.example  com.example 是应用程序包名。 am命令123456789cat /system/bin/am#!/system/bin/shif [ &quot;$1&quot; != &quot;instrument&quot; ] ; then    cmd activity &quot;$@&quot;els">
<meta name="keywords" content="android,aosp">
<meta property="og:type" content="article">
<meta property="og:title" content="The Implementation Details of Android&#39;s force-stop">
<meta property="og:url" content="https://vforkliu.github.io/2019/06/26/The-Implementation-Details-of-Android-s-force-stop/index.html">
<meta property="og:site_name" content="vforkliu">
<meta property="og:description" content="基于AOSP 8.0.1源码分析force-stop的实现细节。 使用 force-stop1am force-stop com.example  com.example 是应用程序包名。 am命令123456789cat /system/bin/am#!/system/bin/shif [ &quot;$1&quot; != &quot;instrument&quot; ] ; then    cmd activity &quot;$@&quot;els">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-06-27T09:33:43.122Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The Implementation Details of Android&#39;s force-stop">
<meta name="twitter:description" content="基于AOSP 8.0.1源码分析force-stop的实现细节。 使用 force-stop1am force-stop com.example  com.example 是应用程序包名。 am命令123456789cat /system/bin/am#!/system/bin/shif [ &quot;$1&quot; != &quot;instrument&quot; ] ; then    cmd activity &quot;$@&quot;els">



  <link rel="alternate" href="/atom.xml" title="vforkliu" type="application/atom+xml">



  
  
  <link rel="canonical" href="https://vforkliu.github.io/2019/06/26/The-Implementation-Details-of-Android-s-force-stop/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>The Implementation Details of Android's force-stop | vforkliu</title>
  




  <script async src="//www.googletagmanager.com/gtag/js?id=UA-142615370-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-142615370-1');
    }
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">vforkliu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">LIU JUN's Blog</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://vforkliu.github.io/2019/06/26/The-Implementation-Details-of-Android-s-force-stop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LIU JUN">
      <meta itemprop="description" content="User Growth,Reverse Engineering,Android Development">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="vforkliu">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">The Implementation Details of Android's force-stop

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-26 18:32:15" itemprop="dateCreated datePublished" datetime="2019-06-26T18:32:15+08:00">2019-06-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-06-27 17:33:43" itemprop="dateModified" datetime="2019-06-27T17:33:43+08:00">2019-06-27</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2019/06/26/The-Implementation-Details-of-Android-s-force-stop/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/06/26/The-Implementation-Details-of-Android-s-force-stop/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>基于AOSP 8.0.1源码分析force-stop的实现细节。</p>
<h1 id="使用-force-stop"><a href="#使用-force-stop" class="headerlink" title="使用 force-stop"></a>使用 force-stop</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am force-stop com.example</span><br></pre></td></tr></table></figure>

<p>com.example 是应用程序包名。</p>
<h1 id="am命令"><a href="#am命令" class="headerlink" title="am命令"></a>am命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /system/bin/am</span><br><span class="line"><span class="meta">#</span><span class="bash">!/system/bin/sh</span></span><br><span class="line">if [ "$1" != "instrument" ] ; then</span><br><span class="line">    cmd activity "$@"</span><br><span class="line">else</span><br><span class="line">    base=/system</span><br><span class="line">    export CLASSPATH=$base/framework/am.jar</span><br><span class="line">    exec app_process $base/bin com.android.commands.am.Am "$@"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>am 是一个shell脚本。如果第一个参数不等于”instrument”，就执行cmd activity。</p>
<h1 id="cmd-命令"><a href="#cmd-命令" class="headerlink" title="cmd 命令"></a>cmd 命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am force-stop com.example</span><br></pre></td></tr></table></figure>

<p>相当于</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd activity force-stop com.example</span><br></pre></td></tr></table></figure>

<p>查看cmd是个什么文件？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /system/bin</span><br><span class="line">file cmd</span><br><span class="line">cmd: ELF shared object, 64-bit LSB arm64, dynamic (/system/bin/linker64), for Android 27, BuildID=684237e221655418caf713b8cedf9382, stripped</span><br></pre></td></tr></table></figure>

<p>可以看出cmd是一个ELF可执行文件。<br>源码文件：frameworks/native/cmds/cmd/cmd.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    Vector&lt;String16&gt; args;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">2</span>; i&lt;argc; i++) &#123;</span><br><span class="line">        args.add(String16(argv[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    String16 cmd = String16(argv[<span class="number">1</span>]);</span><br><span class="line">    sp&lt;IBinder&gt; service = sm-&gt;checkService(cmd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    sp&lt;MyShellCallback&gt; cb = <span class="keyword">new</span> MyShellCallback();</span><br><span class="line">    sp&lt;MyResultReceiver&gt; result = <span class="keyword">new</span> MyResultReceiver();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> block until a result is returned to MyResultReceiver.</span></span><br><span class="line">    <span class="keyword">status_t</span> err = IBinder::shellCommand(service, STDIN_FILENO, STDOUT_FILENO, STDERR_FILENO, args,</span><br><span class="line">            cb, result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>args[1]  表示服务名。<br>通过ServiceManager找到对应的服务，比如第1个参数是activity，找到服务ActivityManagerService。<br>然后调用IBinder::shellCommand()。</p>
<h1 id="IBinder-shellCommand"><a href="#IBinder-shellCommand" class="headerlink" title="IBinder::shellCommand"></a>IBinder::shellCommand</h1><p>frameworks/native/libs/binder/Binder.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IBinder::shellCommand(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; target, <span class="keyword">int</span> in, <span class="keyword">int</span> out, <span class="keyword">int</span> err,</span><br><span class="line">    Vector&lt;String16&gt;&amp; args, <span class="keyword">const</span> sp&lt;IShellCallback&gt;&amp; callback,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IResultReceiver&gt;&amp; resultReceiver)</span><br><span class="line">&#123;</span><br><span class="line">    Parcel send;</span><br><span class="line">    Parcel reply;</span><br><span class="line">    send.writeFileDescriptor(in);</span><br><span class="line">    send.writeFileDescriptor(out);</span><br><span class="line">    send.writeFileDescriptor(err);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> numArgs = args.size();</span><br><span class="line">    send.writeInt32(numArgs);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; numArgs; i++) &#123;</span><br><span class="line">        send.writeString16(args[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    send.writeStrongBinder(callback != <span class="literal">NULL</span> ? IInterface::asBinder(callback) : <span class="literal">NULL</span>);</span><br><span class="line">    send.writeStrongBinder(resultReceiver != <span class="literal">NULL</span> ? IInterface::asBinder(resultReceiver) : <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> target-&gt;transact(SHELL_COMMAND_TRANSACTION, send, &amp;reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数比较简单，构造一个Parcel 执行SHELL_COMMAND_TRANSCTION。</p>
<h1 id="AMS-onShellCommand"><a href="#AMS-onShellCommand" class="headerlink" title="AMS::onShellCommand"></a>AMS::onShellCommand</h1><p>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title">IActivityManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Watchdog</span>.<span class="title">Monitor</span>, <span class="title">BatteryStatsImpl</span>.<span class="title">BatteryCallback</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShellCommand</span><span class="params">(FileDescriptor in, FileDescriptor out,</span></span></span><br><span class="line"><span class="function"><span class="params">            FileDescriptor err, String[] args, ShellCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">            ResultReceiver resultReceiver)</span> </span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> ActivityManagerShellCommand(<span class="keyword">this</span>, <span class="keyword">false</span>)).exec(</span><br><span class="line">                <span class="keyword">this</span>, in, out, err, args, callback, resultReceiver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exec函数在ShellCommand类里实现，最终会调用ActivityManagerShellCommand的onCommand函数。</p>
<h1 id="ActivityManagerShellCommand-onCommand"><a href="#ActivityManagerShellCommand-onCommand" class="headerlink" title="ActivityManagerShellCommand::onCommand"></a>ActivityManagerShellCommand::onCommand</h1><p>frameworks/base/services/core/java/com/android/server/am/ActivityManagerShellCommand.java<br>frameworks/base/core/java/android/os/ShellCommand.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onCommand</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"force-stop"</span>:</span><br><span class="line">        <span class="keyword">return</span> runForceStop(pw);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>runForceStop</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">runForceStop</span><span class="params">(PrintWriter pw)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> userId = UserHandle.USER_ALL;</span><br><span class="line"></span><br><span class="line">    String opt;</span><br><span class="line">    <span class="keyword">while</span> ((opt = getNextOption()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (opt.equals(<span class="string">"--user"</span>)) &#123;</span><br><span class="line">            userId = UserHandle.parseUserArg(getNextArgRequired());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            getErrPrintWriter().println(<span class="string">"Error: Unknown option: "</span> + opt);</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mInterface.forceStopPackage(getNextArgRequired(), userId);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从ActivityManagerShellCommand的构造函数中发现mInterface表示ActivityManagerService。</p>
<h1 id="forceStopPackage"><a href="#forceStopPackage" class="headerlink" title="forceStopPackage"></a>forceStopPackage</h1><p>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceStopPackage</span><span class="params">(<span class="keyword">final</span> String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (checkCallingPermission(android.Manifest.permission.FORCE_STOP_PACKAGES)</span><br><span class="line">            != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        String msg = <span class="string">"Permission Denial: forceStopPackage() from pid="</span></span><br><span class="line">                + Binder.getCallingPid()</span><br><span class="line">                + <span class="string">", uid="</span> + Binder.getCallingUid()</span><br><span class="line">                + <span class="string">" requires "</span> + android.Manifest.permission.FORCE_STOP_PACKAGES;</span><br><span class="line">        Slog.w(TAG, msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">    userId = mUserController.handleIncomingUser(callingPid, Binder.getCallingUid(),</span><br><span class="line">            userId, <span class="keyword">true</span>, ALLOW_FULL_ONLY, <span class="string">"forceStopPackage"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">long</span> callingId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span>[] users = userId == UserHandle.USER_ALL</span><br><span class="line">                    ? mUserController.getUsers() : <span class="keyword">new</span> <span class="keyword">int</span>[] &#123; userId &#125;;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> user : users) &#123;</span><br><span class="line">                <span class="keyword">int</span> pkgUid = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    pkgUid = pm.getPackageUid(packageName, MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                            user);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (pkgUid == -<span class="number">1</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Invalid packageName: "</span> + packageName);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 关键点1</span></span><br><span class="line">                    pm.setPackageStoppedState(packageName, <span class="keyword">true</span>, user);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Failed trying to unstop package "</span></span><br><span class="line">                            + packageName + <span class="string">": "</span> + e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mUserController.isUserRunningLocked(user, <span class="number">0</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 关键点2</span></span><br><span class="line">                    forceStopPackageLocked(packageName, pkgUid, <span class="string">"from pid "</span> + callingPid);</span><br><span class="line">                    finishForceStopPackageLocked(packageName, pkgUid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(callingId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数的参数packageName 表示被杀进程的包名， userId值为UserHandle.USER_ALL。</p>
<h2 id="setPackageStoppedState"><a href="#setPackageStoppedState" class="headerlink" title="setPackageStoppedState"></a>setPackageStoppedState</h2><p>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPackageStoppedState</span><span class="params">(String packageName, <span class="keyword">boolean</span> stopped, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">if</span> (getInstantAppPackageName(callingUid) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permission = mContext.checkCallingOrSelfPermission(</span><br><span class="line">            android.Manifest.permission.CHANGE_COMPONENT_ENABLED_STATE);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> allowedByPermission = (permission == PackageManager.PERMISSION_GRANTED);</span><br><span class="line">    enforceCrossUserPermission(callingUid, userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>, <span class="string">"stop package"</span>);</span><br><span class="line">    <span class="comment">// writer</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (!filterAppAccessLPr(ps, callingUid, userId)</span><br><span class="line">                &amp;&amp; mSettings.setPackageStoppedStateLPw(<span class="keyword">this</span>, packageName, stopped,</span><br><span class="line">                        allowedByPermission, callingUid, userId)) &#123;</span><br><span class="line">            scheduleWritePackageRestrictionsLocked(userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要启动处于停止状态的应用，则只要为Intent添加 FLAG_INCLUDE_STOPPED_PACKAGES 标记即可。</p>
<h1 id="forceStopPackageLocked"><a href="#forceStopPackageLocked" class="headerlink" title="forceStopPackageLocked"></a>forceStopPackageLocked</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">forceStopPackageLocked</span><span class="params">(<span class="keyword">final</span> String packageName, <span class="keyword">int</span> uid, String reason)</span> </span>&#123;</span><br><span class="line">    forceStopPackageLocked(packageName, UserHandle.getAppId(uid), <span class="keyword">false</span>,</span><br><span class="line">            <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, UserHandle.getUserId(uid), reason);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">forceStopPackageLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    String packageName, </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> appId,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> callerWillRestart, // <span class="keyword">false</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> purgeCache,        // <span class="keyword">false</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> doit,              // <span class="keyword">true</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> evenPersistent,    // <span class="keyword">false</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> uninstalling,      // <span class="keyword">false</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> userId, </span></span></span><br><span class="line"><span class="function"><span class="params">    String reason</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL &amp;&amp; packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Can't force stop all processes of all users, that is insane!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (appId &lt; <span class="number">0</span> &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            appId = UserHandle.getAppId(AppGlobals.getPackageManager()</span><br><span class="line">                    .getPackageUid(packageName, MATCH_DEBUG_TRIAGED_MISSING, <span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (doit) &#123;</span><br><span class="line">        <span class="keyword">if</span> (packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Force stopping "</span> + packageName + <span class="string">" appid="</span> + appId</span><br><span class="line">                    + <span class="string">" user="</span> + userId + <span class="string">": "</span> + reason);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Force stopping u"</span> + userId + <span class="string">": "</span> + reason);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAppErrors.resetProcessCrashTimeLocked(packageName == <span class="keyword">null</span>, appId, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理 Processes</span></span><br><span class="line">    <span class="keyword">boolean</span> didSomething = killPackageProcessesLocked(packageName, appId, userId,</span><br><span class="line">            ProcessList.INVALID_ADJ, callerWillRestart, <span class="keyword">true</span>, doit, evenPersistent,</span><br><span class="line">            packageName == <span class="keyword">null</span> ? (<span class="string">"stop user "</span> + userId) : (<span class="string">"stop "</span> + packageName));</span><br><span class="line"></span><br><span class="line">    didSomething |= mActivityStarter.clearPendingActivityLaunchesLocked(packageName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理 Activities</span></span><br><span class="line">    <span class="keyword">if</span> (mStackSupervisor.finishDisabledPackageActivitiesLocked(</span><br><span class="line">            packageName, <span class="keyword">null</span>, doit, evenPersistent, userId)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!doit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        didSomething = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理 Services</span></span><br><span class="line">    <span class="keyword">if</span> (mServices.bringDownDisabledPackageServicesLocked(</span><br><span class="line">            packageName, <span class="keyword">null</span>, userId, evenPersistent, <span class="keyword">true</span>, doit)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!doit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        didSomething = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Remove all sticky broadcasts from this user.</span></span><br><span class="line">        mStickyBroadcasts.remove(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;ContentProviderRecord&gt; providers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (mProviderMap.collectPackageProvidersLocked(packageName, <span class="keyword">null</span>, doit, evenPersistent,</span><br><span class="line">            userId, providers)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!doit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        didSomething = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 清理 Providers</span></span><br><span class="line">    <span class="keyword">for</span> (i = providers.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        removeDyingProviderLocked(<span class="keyword">null</span>, providers.get(i), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除APP申请的临时权限</span></span><br><span class="line">    <span class="comment">// Remove transient permissions granted from/to this package/user</span></span><br><span class="line">    removeUriPermissionsForPackageLocked(packageName, userId, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (doit) &#123;</span><br><span class="line">        <span class="comment">//  清理 Broadcast</span></span><br><span class="line">        <span class="keyword">for</span> (i = mBroadcastQueues.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            didSomething |= mBroadcastQueues[i].cleanupDisabledPackageReceiversLocked(</span><br><span class="line">                    packageName, <span class="keyword">null</span>, userId, doit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span> || uninstalling) &#123;</span><br><span class="line">        <span class="comment">// Remove pending intents.  For now we only do this when force</span></span><br><span class="line">        <span class="comment">// stopping users, because we have some problems when doing this</span></span><br><span class="line">        <span class="comment">// for packages -- app widgets are not currently cleaned up for</span></span><br><span class="line">        <span class="comment">// such packages, so they can be left with bad pending intents.</span></span><br><span class="line">        <span class="keyword">if</span> (mIntentSenderRecords.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Iterator&lt;WeakReference&lt;PendingIntentRecord&gt;&gt; it</span><br><span class="line">                    = mIntentSenderRecords.values().iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                WeakReference&lt;PendingIntentRecord&gt; wpir = it.next();</span><br><span class="line">                <span class="keyword">if</span> (wpir == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    it.remove();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                PendingIntentRecord pir = wpir.get();</span><br><span class="line">                <span class="keyword">if</span> (pir == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    it.remove();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Stopping user, remove all objects for the user.</span></span><br><span class="line">                    <span class="keyword">if</span> (pir.key.userId != userId) &#123;</span><br><span class="line">                        <span class="comment">// Not the same user, skip it.</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (UserHandle.getAppId(pir.uid) != appId) &#123;</span><br><span class="line">                        <span class="comment">// Different app id, skip it.</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (userId != UserHandle.USER_ALL &amp;&amp; pir.key.userId != userId) &#123;</span><br><span class="line">                        <span class="comment">// Different user, skip it.</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!pir.key.packageName.equals(packageName)) &#123;</span><br><span class="line">                        <span class="comment">// Different package, skip it.</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!doit) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                didSomething = <span class="keyword">true</span>;</span><br><span class="line">                it.remove();</span><br><span class="line">                makeIntentSenderCanceledLocked(pir);</span><br><span class="line">                <span class="keyword">if</span> (pir.key.activity != <span class="keyword">null</span> &amp;&amp; pir.key.activity.pendingResults != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pir.key.activity.pendingResults.remove(pir.ref);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (doit) &#123;</span><br><span class="line">        <span class="keyword">if</span> (purgeCache &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            AttributeCache ac = AttributeCache.instance();</span><br><span class="line">            <span class="keyword">if</span> (ac != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ac.removePackage(packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mBooted) &#123;</span><br><span class="line">            <span class="comment">// 恢复 Activity栈</span></span><br><span class="line">            mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">            mStackSupervisor.scheduleIdleLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h1><h2 id="AMS-killPackageProcessesLocked"><a href="#AMS-killPackageProcessesLocked" class="headerlink" title="AMS.killPackageProcessesLocked"></a>AMS.killPackageProcessesLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">killPackageProcessesLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    String packageName, </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> appId,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> userId, </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> minOomAdj, // <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INVALID_ADJ = <span class="number">-10000</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> callerWillRestart, // <span class="keyword">false</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> allowRestart,      // <span class="keyword">true</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> doit,              // <span class="keyword">true</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> evenPersistent,    // <span class="keyword">false</span></span></span></span><br><span class="line"><span class="function"><span class="params">    String reason</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;ProcessRecord&gt; procs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove all processes this package may have touched: all with the</span></span><br><span class="line">    <span class="comment">// same UID (except for the system or root user), and all whose name</span></span><br><span class="line">    <span class="comment">// matches the package name.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NP = mProcessNames.getMap().size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> ip=<span class="number">0</span>; ip&lt;NP; ip++) &#123;</span><br><span class="line">        SparseArray&lt;ProcessRecord&gt; apps = mProcessNames.getMap().valueAt(ip);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> NA = apps.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> ia=<span class="number">0</span>; ia&lt;NA; ia++) &#123;</span><br><span class="line">            ProcessRecord app = apps.valueAt(ia);</span><br><span class="line">            <span class="keyword">if</span> (app.persistent &amp;&amp; !evenPersistent) &#123;</span><br><span class="line">                <span class="comment">// we don't kill persistent processes</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (app.removed) &#123;</span><br><span class="line">                <span class="keyword">if</span> (doit) &#123;</span><br><span class="line">                    procs.add(app);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Skip process if it doesn't meet our oom adj requirement.</span></span><br><span class="line">            <span class="keyword">if</span> (app.setAdj &lt; minOomAdj) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If no package is specified, we call all processes under the</span></span><br><span class="line">            <span class="comment">// give user id.</span></span><br><span class="line">            <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (userId != UserHandle.USER_ALL &amp;&amp; app.userId != userId) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (appId &gt;= <span class="number">0</span> &amp;&amp; UserHandle.getAppId(app.uid) != appId) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// Package has been specified, we want to hit all processes</span></span><br><span class="line">            <span class="comment">// that match it.  We need to qualify this by the processes</span></span><br><span class="line">            <span class="comment">// that are running under the specified app and user ID.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> isDep = app.pkgDeps != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; app.pkgDeps.contains(packageName);</span><br><span class="line">                <span class="keyword">if</span> (!isDep &amp;&amp; UserHandle.getAppId(app.uid) != appId) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (userId != UserHandle.USER_ALL &amp;&amp; app.userId != userId) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!app.pkgList.containsKey(packageName) &amp;&amp; !isDep) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process has passed all conditions, kill it!</span></span><br><span class="line">            <span class="keyword">if</span> (!doit) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            app.removed = <span class="keyword">true</span>;</span><br><span class="line">            procs.add(app);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> N = procs.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        removeProcessLocked(procs.get(i), callerWillRestart, allowRestart, reason);</span><br><span class="line">    &#125;</span><br><span class="line">    updateOomAdjLocked();</span><br><span class="line">    <span class="keyword">return</span> N &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="removeProcessLocked"><a href="#removeProcessLocked" class="headerlink" title="removeProcessLocked"></a>removeProcessLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">removeProcessLocked</span><span class="params">(ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> callerWillRestart, <span class="keyword">boolean</span> allowRestart, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String name = app.processName;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = app.uid;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.d(TAG_PROCESSES,</span><br><span class="line">        <span class="string">"Force removing proc "</span> + app.toShortString() + <span class="string">" ("</span> + name + <span class="string">"/"</span> + uid + <span class="string">")"</span>);</span><br><span class="line"></span><br><span class="line">    ProcessRecord old = mProcessNames.get(name, uid);</span><br><span class="line">    <span class="keyword">if</span> (old != app) &#123;</span><br><span class="line">        <span class="comment">// This process is no longer active, so nothing to do.</span></span><br><span class="line">        Slog.w(TAG, <span class="string">"Ignoring remove of inactive process: "</span> + app);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    removeProcessNameLocked(name, uid);</span><br><span class="line">    <span class="keyword">if</span> (mHeavyWeightProcess == app) &#123;</span><br><span class="line">        mHandler.sendMessage(mHandler.obtainMessage(CANCEL_HEAVY_NOTIFICATION_MSG,</span><br><span class="line">                mHeavyWeightProcess.userId, <span class="number">0</span>));</span><br><span class="line">        mHeavyWeightProcess = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> needRestart = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != MY_PID) &#123;</span><br><span class="line">        <span class="keyword">int</span> pid = app.pid;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            mPidsSelfLocked.remove(pid);</span><br><span class="line">            mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line">        &#125;</span><br><span class="line">        mBatteryStatsService.noteProcessFinish(app.processName, app.info.uid);</span><br><span class="line">        <span class="keyword">boolean</span> willRestart = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (app.persistent &amp;&amp; !app.isolated) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!callerWillRestart) &#123;</span><br><span class="line">                willRestart = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                needRestart = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 杀进程</span></span><br><span class="line">        app.kill(reason, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (app.isolated) &#123;</span><br><span class="line">            mBatteryStatsService.removeIsolatedUid(app.uid, app.info.uid);</span><br><span class="line">            getPackageManagerInternalLocked().removeIsolatedUid(app.uid);</span><br><span class="line">        &#125;</span><br><span class="line">        handleAppDiedLocked(app, willRestart, allowRestart);</span><br><span class="line">        <span class="keyword">if</span> (willRestart) &#123;</span><br><span class="line">            removeLruProcessLocked(app);</span><br><span class="line">            addAppLocked(app.info, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">null</span> <span class="comment">/* ABI override */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mRemovedProcesses.add(app);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> needRestart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="finishForceStopPackageLocked"><a href="#finishForceStopPackageLocked" class="headerlink" title="finishForceStopPackageLocked"></a>finishForceStopPackageLocked</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishForceStopPackageLocked</span><span class="params">(<span class="keyword">final</span> String packageName, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PACKAGE_RESTARTED,</span><br><span class="line">            Uri.fromParts(<span class="string">"package"</span>, packageName, <span class="keyword">null</span>));</span><br><span class="line">    <span class="keyword">if</span> (!mProcessesReady) &#123;</span><br><span class="line">        intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                | Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">    &#125;</span><br><span class="line">    intent.putExtra(Intent.EXTRA_UID, uid);</span><br><span class="line">    intent.putExtra(Intent.EXTRA_USER_HANDLE, UserHandle.getUserId(uid));</span><br><span class="line">    broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, MY_PID, SYSTEM_UID, UserHandle.getUserId(uid));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>清理完与包名相关的进程后，会发送一个ACTION_PACKAGE_RESTARTED广播。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="http://gityuan.com/2014/01/04/get-service/" target="_blank" rel="noopener">http://gityuan.com/2014/01/04/get-service/</a></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag"># android</a>
          
            <a href="/tags/aosp/" rel="tag"># aosp</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/24/JVM-GC/" rel="next" title="JVM:Garbage Collection">
                <i class="fa fa-chevron-left"></i> JVM:Garbage Collection
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/27/Linux-Process/" rel="prev" title="Linux Process">
                Linux Process <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="LIU JUN">
            
              <p class="site-author-name" itemprop="name">LIU JUN</p>
              <div class="site-description motion-element" itemprop="description">User Growth,Reverse Engineering,Android Development</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">34</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/vforkliu" title="GitHub &rarr; https://github.com/vforkliu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:vforkliu@gmail.com" title="E-Mail &rarr; mailto:vforkliu@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#使用-force-stop"><span class="nav-number">1.</span> <span class="nav-text">使用 force-stop</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#am命令"><span class="nav-number">2.</span> <span class="nav-text">am命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cmd-命令"><span class="nav-number">3.</span> <span class="nav-text">cmd 命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IBinder-shellCommand"><span class="nav-number">4.</span> <span class="nav-text">IBinder::shellCommand</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AMS-onShellCommand"><span class="nav-number">5.</span> <span class="nav-text">AMS::onShellCommand</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ActivityManagerShellCommand-onCommand"><span class="nav-number">6.</span> <span class="nav-text">ActivityManagerShellCommand::onCommand</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#forceStopPackage"><span class="nav-number">7.</span> <span class="nav-text">forceStopPackage</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#setPackageStoppedState"><span class="nav-number">7.1.</span> <span class="nav-text">setPackageStoppedState</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#forceStopPackageLocked"><span class="nav-number">8.</span> <span class="nav-text">forceStopPackageLocked</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Process"><span class="nav-number">9.</span> <span class="nav-text">Process</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AMS-killPackageProcessesLocked"><span class="nav-number">9.1.</span> <span class="nav-text">AMS.killPackageProcessesLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#removeProcessLocked"><span class="nav-number">9.2.</span> <span class="nav-text">removeProcessLocked</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#finishForceStopPackageLocked"><span class="nav-number">10.</span> <span class="nav-text">finishForceStopPackageLocked</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">11.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIU JUN</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>




  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://https-vforkliu-github-io.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://vforkliu.github.io/2019/06/26/The-Implementation-Details-of-Android-s-force-stop/";
    this.page.identifier = "2019/06/26/The-Implementation-Details-of-Android-s-force-stop/";
    this.page.title = 'The Implementation Details of Android\'s force-stop';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://https-vforkliu-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    $(function() {
      var offsetTop = $('#comments').offset().top - $(window).height();
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        loadComments();
      } else {
        $(window).on('scroll.disqus_scroll', function() {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = $('#comments').offset().top - $(window).height();
          var scrollTop = $(window).scrollTop();

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            $(window).off('.disqus_scroll');
            loadComments();
          }
        });
      }
    });
  
</script>





  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
